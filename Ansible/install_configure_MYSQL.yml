---
- name: Install and configure MySQL
  hosts: sql
  become: true
  vars_files:
    - vars.yml
 
  tasks:
    - name: Mise à jour du cache des paquets 1
      apt:
        update_cache: yes

    - name: Installation de gpg
      apt:
        name: gnupg
        state: present

    - name: Import de MySQL APT GPG key
      apt_key:
        url: https://repo.mysql.com/RPM-GPG-KEY-mysql
        state: present

    - name: Ajout MySQL APT repository
      apt_repository:
        repo: "deb https://repo.mysql.com/apt/{{ ansible_distribution | lower }}/ {{ ansible_distribution_release | lower }} mysql-8.0"
        state: present
        filename: mysql-apt-config

    

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install MySQL Server package
      apt:
        name: mysql-8.0
        state: present

    - name: Start MySQL 
      service:
        name: mysql
        state: started
        enabled: true

    
    - name: Install Pip3
      apt:
        name: python3-pip
        state: present
    - name: Install libmysql-dev
      apt:
        name: libmysqlclient-dev
        state: present

    - name: Install requirements
      pip: 
        name: 
          - tqdm
          - numpy
          - pandas
          - openpyxl
          - mysql-connector-python
          - PyMySQL
          - mysqlclient
        state: present

    - name: Définir MySQL root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        host: localhost
        login_unix_socket: /var/run/mysqld/mysqld.sock
        state: present


    - name: Créer MySQL user
      mysql_user:
        name: "{{ mysql_user }}"
        password: "{{ mysql_password }}"
        priv: '*.*:ALL'
        host: '%'
        state: present

    - name: Créer MySQL databases
      mysql_db:
        name: cis_nord_warwait
        state: present

    - name: Créer 2ème MySQL database
      mysql_db:
        name: skillmatrix
        state: present


    - name: Install Git
      apt:
        name: git
        state: present

    - name: Créer un dossier s'il n'existe pas déjà
      file:
        path: /home/admin/app
        state: directory

    - name: Clone Git repository
      git:
        repo: https://github.com/simonLongatte/Projectwarwaitcap.git
        dest: /home/admin/app
        version: development
        force: yes

    

    - name: Mettre à jour les valeurs d'utilisateur et de mot de passe dans withoutGr.py
      template:
        src: withoutGr.py.j2
        dest: /home/admin/app/Projet/AppPython/withoutGr.py
      
    - name: Init Wait Room
      command: python3 Projet/AppPython/withoutGr.py -W '/home/admin/Wait_Room_2023.xlsx'
      args:
        chdir: /home/admin/app

    - name: Init Matrice
      command: python3 Projet/AppPython/withoutGr.py -MC '/home/admin/Matrice_des_competences.xlsx'
      args:
        chdir: /home/admin/app

- name: Dernières modifications apache2
  hosts: web
  become: true
  tasks:
    - name: owner for /var/www/html
      file:
        path: /var/www/html
        owner: www-data
        group: www-data
        recurse: yes

    - name: permissions for /var/www/html/script
      file:
        path: /var/www/html/script
        recurse: yes
        mode: "a+x"

    - name: Modify Apache configuration
      lineinfile:
        path: /etc/apache2/apache2.conf
        regexp: '^<Directory /var/www/>'
        line: '<Directory /var/www/html/>'

    - name: Install MySQL Client on Debian/Ubuntu
      apt:
        name: default-mysql-client
        state: present


    - name: restart apache2
      service:
        name: apache2
        state: restarted